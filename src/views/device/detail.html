{% extends "layout.html" %}

{% block title %}
{{title}}
{% endblock title %}

{% block additional_head %}
<link rel="stylesheet" href="../../public/device/detail.css">
{% endblock additional_head %}

{% block content %}
<section name="device-page" class="container d-flex flex-column my-5">
    <nav>
        <a href="/" class="btn btn-secondary">Back</a>
    </nav>
    <h2 class="mt-3">{{ device.device_name }}</h2>
    <div id="controls" class="d-flex flex-column justify-content-between">
        <button id="device-toggle-btn" class="state-control btn btn-primary d-flex flex-column justify-content-center align-self-sm-start">
            Off
        </button>
        {% if device.device_type == "AirConditioner" %}
        <div class="temp-control mt-5">
            <section id="temperature-control" class="d-flex flex-row align-items-center">
                <button type="button" id="temp-decrease-btn" class="btn btn-outline-secondary">-</button>
                <div id="temp">16</div>
                <button type="button" id="temp-increase-btn" class="btn btn-outline-secondary">+</button>
            </section>
        </div>
        {% endif %}
        <div class="timer-control">
            <!-- On timer -->
            <div class="d-flex flex-row justify-content-sm-start justify-content-between mt-2 align-items-center">
                <input type="time" name="timer-on-setter" id="timer-on-setter" value="00:00">
                <div class="form-check form-switch ms-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="timer-on-switch">
                </div>
            </div>

            <!-- Off timer -->
            <div class="d-flex flex-row justify-content-sm-start justify-content-between mt-2 align-items-center">
                <input type="time" name="timer-on-setter" id="timer-off-setter" value="00:00">
                <div class="form-check form-switch ms-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="timer-off-switch">
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block additional_scripts %}
<script>
    $(document).ready(function () {
        let state = {
            device_id: parseInt("{{ device.device_id }}"),
            device_type: "{{ device.device_type }}",
            status: "Off",
            temperature: 16,
            is_timer_on: false,
            is_timer_off: false,
            timer_on: "00:00",
            timer_off: "00:00"
        }

        const deviceToggleBtn = "#device-toggle-btn";
        const temp = "#temp";
        const tempDecreaseBtn = "#temp-decrease-btn";
        const tempIncreaseBtn = "#temp-increase-btn";
        const timerOnSwitch = "#timer-on-switch";
        const timerOffSwitch = "#timer-off-switch";

        const isAircon = "{{ device.device_type}}" == "AirConditioner";
        function publishStatus(callback) {
            $.ajax({
                url: "{{ url|safe }}",
                type: "POST",
                data: {
                    device_type: state.device_type,
                    device_id: state.device_id,
                    status: state.status,
                    temperature: state.temperature,
                    is_timer_on: state.is_timer_on,
                    is_timer_off: state.is_timer_off,
                    timer_on: state.timer_on,
                    timer_off: state.timer_off
                },
                success: function (response) {
                    callback(response);
                },
                error: function (error) {
                    console.error(error);
                }
            });
        }

        function toggleStatus(buttonSelector) {
            $(buttonSelector).click(function (event) {
                let currentStatus = $(deviceToggleBtn).text().trim();
                let newStatus = currentStatus == "Off" ? "On" : "Off";
                state.status = newStatus;

                publishStatus(function(response) {
                    $(deviceToggleBtn).text(newStatus);
                });
            });
        }
        toggleStatus(deviceToggleBtn);

        function decreaseTemp(buttonSelector) {
            $(buttonSelector).click(function (event) {
                let currentTemp = parseInt($(temp).text());
                let newTemp = currentTemp - 1;
                if (newTemp < 16) {
                    newTemp = 16;
                }
                state.temperature = newTemp;
                publishStatus(function (response) {
                        $(temp).text(newTemp);
                });
            });
        }

        function increaseTemp(buttonSelector) {
            $(buttonSelector).click(function (event) {
                let currentTemp = parseInt($(temp).text());
                let newTemp = currentTemp + 1;
                if (newTemp > 30) {
                    newTemp = 30;
                }
                state.temperature = newTemp;
                publishStatus(function (response) {
                        $(temp).text(newTemp);
                });
            });
        }

        if (isAircon) {
            decreaseTemp(tempDecreaseBtn);
            increaseTemp(tempIncreaseBtn);
        }

        function setTimer(buttonSelector, timerType = "On") {
            $(buttonSelector).click(function (event) {
                let isChecked = $(buttonSelector).prop('checked');
                let timer = $(`#timer-${timerType.toLowerCase()}-setter`).val();
                state[`timer_${timerType.toLowerCase()}`] = timer;
                state[`is_timer_${timerType.toLowerCase()}`] = isChecked;
                publishStatus(function (response) {
                    $(`#timer-${timerType.toLowerCase()}-show`).text(timer);
                    $(`#timer-${timerType.toLowerCase()}-modal`).modal("hide");
                });
            });
        }
        setTimer(timerOnSwitch, "On");
        setTimer(timerOffSwitch, "Off");
    });
</script>
{% endblock additional_scripts %}