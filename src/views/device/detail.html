{% extends "layout.html" %}

{% block title %}
{{title}}
{% endblock title %}

{% block additional_head %}
<link rel="stylesheet" href="../../public/device/detail.css">
{% endblock additional_head %}

{% block content %}
<section name="device-page" class="container d-flex flex-column my-5">
    <nav>
        <a href="/" class="btn btn-secondary">Back</a>
    </nav>
    <h2 class="mt-3">{{ device.device_name }}</h2>
    <div id="controls" class="d-flex flex-column justify-content-between">
        <div class="state-control">
            <button id="device-toggle-btn" class="btn btn-primary">
                Off
            </button>
        </div>
        {% if device.device_type == "AirConditioner" %}
        <div class="temp-control">
            <section id="temperature-control" class="d-flex flex-row align-items-center">
                <button type="button" id="temp-decrease-btn" class="btn btn-outline-secondary">-</button>
                <div id="temp">16</div>
                <button type="button" id="temp-increase-btn" class="btn btn-outline-secondary">+</button>
            </section>
        </div>
        {% endif %}
        <div class="timer-control">

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#timer-on-modal">
                On timer
            </button>

            <!-- Modal -->
            <div class="modal fade" id="timer-on-modal" tabindex="-1" role="dialog"
                aria-labelledby="timer-on-modal-title" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">On timer</h5>
                        </div>
                        <div class="modal-body">
                            <input type="time" name="timer-on-setter" id="timer-on-setter" value="00:00">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" id="timer-on-set-btn" class="btn btn-primary">OK</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#timer-off-modal">
                Off timer
            </button>

            <!-- Modal -->
            <div class="modal fade" id="timer-off-modal" tabindex="-1" role="dialog"
                aria-labelledby="timer-off-modal-title" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Off timer</h5>
                        </div>
                        <div class="modal-body">
                            <input type="time" name="timer-off-setter" id="timer-off-setter" value="00:00">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" id="timer-off-set-btn" class="btn btn-primary">OK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block additional_scripts %}
<script>
    $(document).ready(function () {
        let state = {
            status: "Off",
            temperature: 16,
            is_timer_on: false,
            is_timer_off: false,
            timer_on: "00:00",
            timer_off: "00:00"
        }

        const deviceToggleBtn = "#device-toggle-btn";
        const temp = "#temp";
        const tempDecreaseBtn = "#temp-decrease-btn";
        const tempIncreaseBtn = "#temp-increase-btn";
        const timerOnSetBtn = "#timer-on-set-btn";
        const timerOffSetBtn = "#timer-off-set-btn";

        const isAircon = "{{ device.device_type}}" == "AirConditioner";
        function publishStatus(callback) {
            $.ajax({
                url: "{{ url|safe }}",
                type: "POST",
                data: {
                    status: state.status,
                    temperature: state.temperature,
                    is_timer_on: state.is_timer_on,
                    is_timer_off: state.is_timer_off,
                    timer_on: state.timer_on,
                    timer_off: state.timer_off
                },
                success: function (response) {
                    callback(response);
                },
                error: function (error) {
                    console.error(error);
                }
            });
        }

        function toggleStatus(buttonSelector) {
            $(buttonSelector).click(function (event) {
                let currentStatus = $(deviceToggleBtn).text().trim();
                let newStatus = currentStatus == "Off" ? "On" : "Off";
                state.status = newStatus;

                publishStatus(function(response) {
                    $(deviceToggleBtn).text(newStatus);
                });
            });
        }
        toggleStatus(deviceToggleBtn);

        function decreaseTemp(buttonSelector) {
            $(buttonSelector).click(function (event) {
                let currentTemp = parseInt($(temp).text());
                let newTemp = currentTemp - 1;
                if (newTemp < 16) {
                    newTemp = 16;
                }
                state.temperature = newTemp;
                publishStatus(function (response) {
                        $(temp).text(newTemp);
                });
            });
        }

        function increaseTemp(buttonSelector) {
            $(buttonSelector).click(function (event) {
                let currentTemp = parseInt($(temp).text());
                let newTemp = currentTemp + 1;
                if (newTemp > 30) {
                    newTemp = 30;
                }
                state.temperature = newTemp;
                publishStatus(function (response) {
                        $(temp).text(newTemp);
                });
            });
        }

        if (isAircon) {
            decreaseTemp(tempDecreaseBtn);
            increaseTemp(tempIncreaseBtn);
        }

        function setTimer(buttonSelector, timerType = "On") {
            $(buttonSelector).click(function (event) {
                let timer = $(`#timer-${timerType.toLowerCase()}-setter`).val();
                state[`timer_${timerType.toLowerCase()}`] = timer;
                state[`is_timer_${timerType.toLowerCase()}`] = true;
                publishStatus(function (response) {
                    $(`#timer-${timerType.toLowerCase()}-modal`).modal("hide");
                });
            });
        }
        setTimer(timerOnSetBtn, "On");
        setTimer(timerOffSetBtn, "Off");
    });
</script>
{% endblock additional_scripts %}